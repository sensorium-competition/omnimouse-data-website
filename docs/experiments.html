<!-- experiments.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Experiment Details</title>
<link rel="icon" href="/assets/favicon.png" type="image/png">
<style>
body { font-family: Roboto, sans-serif; margin: 2rem; background: #fff; color: #222; }
.md-typeset h1, .md-typeset h2 { margin-top: 1.5rem; }
.md-typeset p { margin: 0.5rem 0; }
.md-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
.md-table th, .md-table td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
.md-table th { background: #f2f2f2; }
.status { margin-top: 1rem; font-weight: bold; }
a { text-decoration: none; color: #1a73e8; }
a:hover { text-decoration: underline; }
</style>
</head>
<body>

<div class="md-typeset">
  <h1>Experiment Metadata</h1>
  <h2><strong>experiment_id:</strong> <span id="exp-id"></span></h2>
  <p><strong>animal_id:</strong> <span id="exp-animal"></span></p>
  <p><strong>session:</strong> <span id="exp-session"></span></p>
  <p><strong>scan_idx:</strong> <span id="exp-scan"></span></p>

  <table class="md-table" id="exp-table">
    <thead><tr><th>Key</th><th>Value</th></tr></thead>
    <tbody></tbody>
  </table>

  <p class="status" id="status">Loading experiment data…</p>
  <p><a href="metadata_query/">Back to table</a></p>
</div>

<script>
(function() {
    function getQueryParam(name) {
        return new URLSearchParams(window.location.search).get(name);
    }

    const experimentId = getQueryParam('id');
    const statusEl = document.getElementById('status');

    if (!experimentId) {
        statusEl.textContent = "⚠️ No experiment ID provided in the URL.";
        return;
    }

    const baseURL = window.location.origin + window.location.pathname.replace(/\/[^/]*$/, '');
    const jsonPath = `${baseURL}/experiment_metadata/full_combined_meta.json`;

    fetch(jsonPath)
      .then(response => {
        if (!response.ok) throw new Error('Metadata file not found');
        return response.json();
      })
      .then(data => {
        const expData = data[experimentId];
        if (!expData) {
            statusEl.textContent = `⚠️ Experiment "${experimentId}" not found.`;
            return;
        }

        const scan = expData.scan_key || {};

        document.getElementById('exp-id').textContent = experimentId;
        document.getElementById('exp-animal').textContent = scan.animal_id || "-";
        document.getElementById('exp-session').textContent = scan.session ?? "-";
        document.getElementById('exp-scan').textContent = scan.scan_idx ?? "-";

        const container = document.getElementById('exp-table').parentElement;
        document.getElementById('exp-table').remove(); // remove default table

        for (const key in expData) {
            if (key === "scan_key") continue;

            const sectionData = expData[key];
            if (typeof sectionData !== "object" || sectionData === null) continue;

            // Section title
            const title = document.createElement("h3");
            title.textContent = key;
            container.appendChild(title);

            // Create table
            const table = document.createElement("table");
            table.className = "md-table";

            const thead = document.createElement("thead");
            thead.innerHTML = "<tr><th>Key</th><th>Value</th></tr>";

            const tbody = document.createElement("tbody");

            Object.entries(sectionData).forEach(([subKey, value]) => {
                function renderValue(value, container) {
                    if (value === null) {
                        container.textContent = "null";
                        return;
                    }

                    if (typeof value !== "object") {
                        container.textContent = value;
                        return;
                    }

                    const table = document.createElement("table");
                    table.className = "md-table";

                    const tbody = document.createElement("tbody");

                    Object.entries(value).forEach(([k, v]) => {
                        const row = document.createElement("tr");

                        const keyCell = document.createElement("td");
                        keyCell.textContent = k;

                        const valueCell = document.createElement("td");
                        renderValue(v, valueCell);

                        row.appendChild(keyCell);
                        row.appendChild(valueCell);
                        tbody.appendChild(row);
                    });

                    table.appendChild(tbody);
                    container.appendChild(table);
                }
                const row = document.createElement("tr");

                const keyCell = document.createElement("td");
                keyCell.textContent = subKey;

                const valueCell = document.createElement("td");
                renderValue(value, valueCell);

                row.appendChild(keyCell);
                row.appendChild(valueCell);
                tbody.appendChild(row);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
            container.appendChild(table);
        }
        statusEl.remove();
      })
      .catch(err => {
        statusEl.textContent = "⚠️ Error: Metadata file not found.";
        console.error(err);
      });
})();
</script>

<script>
const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

if (prefersDark) {
    document.documentElement.style.setProperty('--bg-color', '#121212');
    document.documentElement.style.setProperty('--text-color', '#ffffff');
    document.documentElement.style.setProperty('--link-color', '#8ab4f8');
    document.documentElement.style.setProperty('--table-header-bg', '#1e1e1e');
    document.documentElement.style.setProperty('--table-border', '#333');
}
</script>

<style>
.md-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    table-layout: fixed;   /* forces identical column widths */
}

.md-table th,
.md-table td {
    border: 1px solid var(--table-border);
    padding: 0.5rem;
    text-align: left;
    vertical-align: top;
    word-break: break-word;      /* wrap long strings */
    overflow-wrap: anywhere;     /* prevent overflow */
}

.md-table th {
    background: var(--table-header-bg);
    width: 30%;   /* fixed width for Key column */
}

.md-table td {
    width: 70%;   /* fixed width for Value column */
}

:root {
    --bg-color: #ffffff;
    --text-color: #222222;
    --link-color: #1a73e8;
    --table-header-bg: #f2f2f2;
    --table-border: #ccc;
}

body {
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: Roboto, sans-serif;
    margin: 2rem;
}

a { color: var(--link-color); text-decoration: none; }
a:hover { text-decoration: underline; }

.md-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
.md-table th, .md-table td { border: 1px solid var(--table-border); padding: 0.5rem; text-align: left; }
.md-table th { background: var(--table-header-bg); }

.status { margin-top: 1rem; font-weight: bold; }
.md-typeset h1, .md-typeset h2 { margin-top: 1.5rem; }
</style>

</body>
</html>
